name: Build & Deploy on self-hosted

on:
  push:
    branches: [ main, dev ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Create .env from example
        run: cp .env.example .env

      - name: Stop and remove existing containers
        run: |
          cd ${{ github.workspace }}
          docker compose down || true

      - name: Build and start services
        run: |
          cd ${{ github.workspace }}
          docker compose up -d --build

      - name: Verify services are running
        run: |
          cd ${{ github.workspace }}
          docker compose ps
          sleep 5
          docker compose logs app --tail=50

